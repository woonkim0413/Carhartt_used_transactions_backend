name: Commit Keyword Discord Notification

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'   # í•„ìš” ì—†ìœ¼ë©´ ì§€ì›Œë„ ë¨
  pull_request:
    branches:
      - main
      - develop
      - 'feature/**'

jobs:
  notify-on-keyword:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # ì»¤ë°‹ ë²”ìœ„ ìŠ¤ìº” ìœ„í•´ ì „ì²´ ížˆìŠ¤í† ë¦¬

      - name: Fetch base branch (for PR)
        if: ${{ github.event_name == 'pull_request' }}
        run: git fetch origin ${{ github.base_ref }}:${{ github.base_ref }}

      - name: Scan commit messages for keyword
        id: scan
        env:
          KEYWORD: "[API ë³€ê²½]"   # â† ì›í•˜ëŠ” í‚¤ì›Œë“œë¡œ ë°”ê¿”ë„ ë¨
        run: |
          # ë¹„êµ ë²”ìœ„ ê²°ì •
          if [ "${{ github.event_name }}" = "push" ]; then
            BASE="${{ github.event.before }}"
            HEAD="${{ github.sha }}"
            if [ "$BASE" = "0000000000000000000000000000000000000000" ] || [ -z "$BASE" ]; then
              RANGE="$HEAD~50..$HEAD"     # ìƒˆ ë¸Œëžœì¹˜ ì²« push ë°©ì–´
            else
              RANGE="$BASE..$HEAD"
            fi
            LOG=$(git log --pretty=format:'%h %s' "$RANGE")
          else
            # PR: base..HEAD ë²”ìœ„ì˜ ì»¤ë°‹ë“¤
            LOG=$(git log --pretty=format:'%h %s' ${{ github.base_ref }}..HEAD)
          fi

          echo "=== Scan range commits ==="
          echo "$LOG"

          # ëŒ€ì†Œë¬¸ìž êµ¬ë¶„ ì—†ì´ í‚¤ì›Œë“œ ë§¤ì¹­
          MATCHED=$(echo "$LOG" | grep -i -F "$KEYWORD" || true)

          if [ -n "$MATCHED" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "$MATCHED" | head -c 1800 > matched.txt
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

          # PR/Push ê³µí†µìœ¼ë¡œ í‘œì‹œìš© ì •ë³´ ì¤€ë¹„
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "title=Commit keyword detected (Push)" >> $GITHUB_OUTPUT
            echo "author=${{ github.actor }}" >> $GITHUB_OUTPUT
            echo "branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "url=${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "title=Commit keyword detected (Pull Request)" >> $GITHUB_OUTPUT
            echo "author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
            echo "branch=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
            echo "url=${{ github.event.pull_request.html_url }}" >> $GITHUB_OUTPUT
          fi

      - name: Post to Discord
        if: steps.scan.outputs.found == 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          REPO="${{ github.repository }}"
          TITLE="${{ steps.scan.outputs.title }}"
          AUTHOR="${{ steps.scan.outputs.author }}"
          BRANCH="${{ steps.scan.outputs.branch }}"
          URL="${{ steps.scan.outputs.url }}"
          BODY="$(cat matched.txt)"

          # ìž„ë² ë“œ ìƒ‰ìƒ (í‘¸ì‹œ=ì´ˆë¡, PR=ë…¸ëž‘)
          if [ "${{ github.event_name }}" = "push" ]; then COLOR=3066993; else COLOR=15844367; fi

          jq -n --arg title "$TITLE" \
                --arg repo "$REPO" \
                --arg author "$AUTHOR" \
                --arg branch "$BRANCH" \
                --arg url "$URL" \
                --arg body "$BODY" \
                --arg color "$COLOR" '
          {
            "embeds": [{
              "title": $title,
              "description": "ì»¤ë°‹ ë©”ì‹œì§€ì—ì„œ í‚¤ì›Œë“œê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.",
              "color": ($color|tonumber),
              "fields": [
                {"name":"ðŸ“ Repository","value":$repo,"inline":true},
                {"name":"ðŸŒ¿ Branch","value":("`"+$branch+"`"),"inline":true},
                {"name":"ðŸ‘¤ Author","value":$author,"inline":true},
                {"name":"ðŸ”— Link","value":$url,"inline":false},
                {"name":"ðŸ“ Matched Commits","value":("```\\n"+$body+"\\n```"),"inline":false}
              ],
              "timestamp": (now|tojson)
            }]
          }' > payload.json

          curl -H "Content-Type: application/json" -d @payload.json "$DISCORD_WEBHOOK_URL"

      - name: Summary
        if: steps.scan.outputs.found == 'true'
        run: |
          echo "## âœ… Commit keyword detected" >> $GITHUB_STEP_SUMMARY
          echo "- **Repository**: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ steps.scan.outputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ steps.scan.outputs.url }}" >> $GITHUB_STEP_SUMMARY
