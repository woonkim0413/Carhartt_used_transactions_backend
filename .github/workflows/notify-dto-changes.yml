name: DTO Changes Discord Notification

# ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì¡°ê±´
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  notify-dto-changes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµí•˜ê¸° ìœ„í•´ 2ê°œ ì»¤ë°‹ ê°€ì ¸ì˜¤ê¸°

      - name: Get changed DTO files
        id: changed-files
        run: |
          # ë³€ê²½ëœ DTO íŒŒì¼ë“¤ì„ ì°¾ê¸°
          if [ "${{ github.event_name }}" = "push" ]; then
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E "(dto|DTO)" | grep "\.java$" || true)
          else
            CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}..HEAD | grep -E "(dto|DTO)" | grep "\.java$" || true)
          fi
          
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # ë³€ê²½ëœ íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
          if [ -n "$CHANGED_FILES" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "file_count=$(echo "$CHANGED_FILES" | sed '/^\s*$/d' | wc -l | tr -d ' ')" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "file_count=0" >> $GITHUB_OUTPUT
          fi

      - name: Get commit information
        id: commit-info
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            COMMIT_SHA="${{ github.sha }}"
            COMMIT_MSG=$(git log -1 --pretty=format:'%s')
            COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
            COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"
            BRANCH_NAME="${{ github.ref_name }}"
          else
            COMMIT_SHA="${{ github.event.pull_request.head.sha }}"
            COMMIT_MSG="${{ github.event.pull_request.title }}"
            COMMIT_AUTHOR="${{ github.event.pull_request.user.login }}"
            COMMIT_URL="${{ github.event.pull_request.html_url }}"
            BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          fi
          
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "commit_msg=$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "commit_author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
          echo "commit_url=$COMMIT_URL" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Send Discord notification
        # ê¸°ì¡´ has_changes ì¡°ê±´ì— ë”í•´ ì»¤ë°‹ ë©”ì‹œì§€ê°€ "[API ë³€ê²½]" ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš°ì—ë§Œ ì‹¤í–‰
        if: ${{ steps.changed-files.outputs.has_changes == 'true' && startsWith(steps.commit-info.outputs.commit_msg, '[API ë³€ê²½]') }}
        run: |
          # Discord ì›¹í›… URL (GitHub Secretsì— ì €ì¥ëœ ê°’ ì‚¬ìš©)
          DISCORD_WEBHOOK_URL="${{ secrets.DISCORD_WEBHOOK_URL }}"
          
          # ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ì„ í¬ë§·íŒ…
          CHANGED_FILES="${{ steps.changed-files.outputs.changed_files }}"
          FORMATTED_FILES=""
          while IFS= read -r file; do
            if [ -n "$file" ]; then
              FORMATTED_FILES="$FORMATTED_FILESâ€¢ \`$file\`\n"
            fi
          done <<< "$CHANGED_FILES"
          
          # ì´ë²¤íŠ¸ íƒ€ì…ì— ë”°ë¥¸ ì œëª© ì„¤ì •
          if [ "${{ github.event_name }}" = "push" ]; then
            TITLE="API ìŠ¤í™ ë³€ê²½ ê°ì§€ (Push)"
            COLOR=3066993  # ì´ˆë¡ìƒ‰
          else
            TITLE="API ìŠ¤í™ ë³€ê²½ ê°ì§€ (Pull Request)"
            COLOR=15844367  # ë…¸ë€ìƒ‰
          fi
          
          # Discord ë©”ì‹œì§€ JSON ìƒì„±
          cat << EOF > discord_payload.json
          {
            "embeds": [
              {
                "title": "$TITLE",
                "description": "API ì˜ ë³€ê²½ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ë³€ê²½ëœ DTO í´ë˜ìŠ¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.",
                "color": $COLOR,
                "fields": [
                  {
                    "name": "ğŸ“ Repository",
                    "value": "[${{ github.repository }}](${{ github.server_url }}/${{ github.repository }})",
                    "inline": true
                  },
                  {
                    "name": "ğŸŒ¿ Branch",
                    "value": "\`${{ steps.commit-info.outputs.branch_name }}\`",
                    "inline": true
                  },
                  {
                    "name": "ğŸ‘¤ Author",
                    "value": "${{ steps.commit-info.outputs.commit_author }}",
                    "inline": true
                  },
                  {
                    "name": "ğŸ’¬ Commit Message",
                    "value": "${{ steps.commit-info.outputs.commit_msg }}",
                    "inline": false
                  },
                  {
                    "name": "ğŸ“„ Changed Files (${{ steps.changed-files.outputs.file_count }}ê°œ)",
                    "value": "$FORMATTED_FILES",
                    "inline": false
                  },
                  {
                    "name": "ğŸ”— View Changes",
                    "value": "[Click here to view](${{ steps.commit-info.outputs.commit_url }})",
                    "inline": false
                  }
                ],
                "footer": {
                  "text": "GitHub Actions â€¢ ${{ github.workflow }}",
                  "icon_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
                },
                "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.%3NZ)"
              }
            ]
          }
          EOF
          
          # Discord ì›¹í›…ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡
          curl -H "Content-Type: application/json" \
               -d @discord_payload.json \
               "$DISCORD_WEBHOOK_URL"
          
          echo "Discord ì•Œë¦¼ì´ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!"

      - name: Summary
        # Summaryë„ ë™ì¼ ì¡°ê±´ì—ì„œë§Œ ì¶œë ¥ë˜ë„ë¡ ë³€ê²½ (ì˜µì…˜)
        if: ${{ steps.changed-files.outputs.has_changes == 'true' && startsWith(steps.commit-info.outputs.commit_msg, '[API ë³€ê²½]') }}
        run: |
          echo "## ğŸ“Š DTO ë³€ê²½ ê°ì§€ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ë³€ê²½ëœ íŒŒì¼ ìˆ˜**: ${{ steps.changed-files.outputs.file_count }}ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¸Œëœì¹˜**: ${{ steps.commit-info.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì»¤ë°‹ ì‘ì„±ì**: ${{ steps.commit-info.outputs.commit_author }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Discord ì•Œë¦¼**: âœ… ì „ì†¡ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ë³€ê²½ëœ íŒŒì¼ ëª©ë¡" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.changed-files.outputs.changed_files }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
